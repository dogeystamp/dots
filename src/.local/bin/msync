#!/bin/sh

# Sync files to the main device for categorisation and renaming.

set -e

while getopts ":pr" o; do
	case "${o}" in
		p) ACTION=PUSH ;;
		r) ACTION=RECV ;;
	esac
done


# Setup ssh agent to avoid repeated password prompts
eval `ssh-agent -s`

ssh-add ~/.ssh/keys/gamma

if [ $ACTION = PUSH ]
then
	# Optionally send sorted files back
	echo Push action is not implemented.
fi

if [ $ACTION = RECV ]
then
	# Move files to the quarantine zone for categorisation and renaming

	rsync -avPzc gamma:~/storage/pictures/Infinity/ ~/quar

	rsync -avPzc gamma:~/storage/movies/Infinity/ ~/quar

	rsync -avPzc gamma:~/storage/dcim/OpenCamera/ ~/quar

	rsync -avPzc "gamma:~/storage/shared/Recordings/Sound records/" ~/quar

	rsync -avPzc gamma:~/dr ~/quar

	# Delete remote files

	echo 'rm -rf ~/storage/pictures/Infinity/* ~/storage/movies/Infinity/* ~/storage/dcim/OpenCamera/* "~/storage/shared/Recordings/Sound records/*"' | ssh gamma /bin/sh
	ssh gamma 'echo > dr'
fi

# Kill ssh agent
kill $SSH_AGENT_PID
